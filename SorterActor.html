<!DOCTYPE html><html lang="en"><head><title>SorterActor</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="SorterActor"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/SorterActor.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/SorterActor.scala">src/main/scala/net/pierreandrews/SorterActor.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">package</span> net.pierreandrews

<span class="hljs-keyword">import</span> java.io.{ <span class="hljs-type">File</span>, <span class="hljs-type">PrintWriter</span> }

<span class="hljs-keyword">import</span> akka.actor.{ <span class="hljs-type">ActorLogging</span>, <span class="hljs-type">Props</span>, <span class="hljs-type">Actor</span> }
<span class="hljs-keyword">import</span> akka.event.<span class="hljs-type">LoggingReceive</span>
<span class="hljs-keyword">import</span> net.pierreandrews.<span class="hljs-type">Protocol</span>.{ <span class="hljs-type">FileNameData</span>, <span class="hljs-type">SortUser</span>, <span class="hljs-type">GiveMeWork</span>, <span class="hljs-type">StartSorting</span> }
<span class="hljs-keyword">import</span> net.pierreandrews.<span class="hljs-type">SorterActor</span>.<span class="hljs-type">SorterWorkerActor</span>
<span class="hljs-keyword">import</span> net.pierreandrews.utils.<span class="hljs-type">LineSorter</span>
<span class="hljs-keyword">import</span> net.pierreandrews.utils.<span class="hljs-type">LogSplitUtils</span>.<span class="hljs-type">JoinIterators</span>
<span class="hljs-keyword">import</span> org.joda.time.{ <span class="hljs-type">DateTimeComparator</span>, <span class="hljs-type">DateTime</span> }

<span class="hljs-keyword">import</span> scala.annotation.tailrec
<span class="hljs-keyword">import</span> scala.io.<span class="hljs-type">Source</span>
<span class="hljs-keyword">import</span> scala.util.control.<span class="hljs-type">NonFatal</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Manages the sorting of the partial files for each userid.
Once the log distribution is done, we are left with a number of part files coming from each server
each part file is sorted but all the parts are not globally sorted. Once we are done collecting logs,
we have to sort the lines again.</p>
<p>This is the manager and will start a number of workers and distribute the workload to them with a pull logic.
  Each worker starts sorting a set of files for one user; when it&#39;s done, it asks for more work to the manager.
  The pull pattern allows for distributing more work to the fastest sorter and balancing work better.</p>
<p>User: pierre
Date: 11/28/14</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SorterActor</span>(</span>args: <span class="hljs-type">LogSplitAppArgs</span>) <span class="hljs-keyword">extends</span> <span class="hljs-type">Actor</span> <span class="hljs-keyword">with</span> <span class="hljs-type">ActorLogging</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>file pattern to read logs from. This are the part output of the WriterActor (as defined in FileCache)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">ValidPartFile</span> =</span> <span class="hljs-string">"(.*).([0-9]+).([0-9]+).part$"</span>.r</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the files to process grouped by users</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> fileGroups: <span class="hljs-type">Iterator</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Seq</span>[<span class="hljs-type">FileNameData</span>])] = <span class="hljs-type">Iterator</span>()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the number of active children. When this reaches 0, we are done sorting everything.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> childCount = args.numSortWorkers

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span>:</span> <span class="hljs-type">Receive</span> = <span class="hljs-type">LoggingReceive</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">StartSorting</span> =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the log distribution is done, we know have all the logs for a set of users
on this node and want to sort the part files together in one file. Start the workers and
distribute work</p></div></div><div class="code"><div class="wrapper">      log.info(<span class="hljs-string">"START SORTING"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>load the list of log parts</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">files</span>:</span> <span class="hljs-type">Seq</span>[<span class="hljs-type">FileNameData</span>] = <span class="hljs-type">Option</span>(args.output.listFiles)
        .map(_.toSeq)
        .getOrElse(<span class="hljs-type">Seq</span>())
        .flatMap { file =&gt;
          file.getName <span class="hljs-keyword">match</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>only keep the ones that match our pattern and extract dome data at the same time.</p></div></div><div class="code"><div class="wrapper">            <span class="hljs-keyword">case</span> <span class="hljs-type">ValidPartFile</span>(userid, serverId, partId) =&gt; <span class="hljs-type">Some</span>(<span class="hljs-type">FileNameData</span>(userid, serverId.toInt, partId.toInt, file))
            <span class="hljs-keyword">case</span> _ =&gt; <span class="hljs-type">None</span>
          }
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>group the part files per user, we need to merge these</p></div></div><div class="code"><div class="wrapper">      fileGroups = files.groupBy(_.userId).toIterator</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Start Workers</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until args.numSortWorkers) {
        context.actorOf(<span class="hljs-type">Props</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">SorterWorkerActor</span>(args)))
      }

    <span class="hljs-keyword">case</span> <span class="hljs-type">GiveMeWork</span> =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>give work to available worker</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (fileGroups.hasNext) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get the next set of files to merge and send them to the worker</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> (</span>userid, files) = fileGroups.next()
        sender() ! <span class="hljs-type">SortUser</span>(userid, files)
      } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>no more work, stop that worker</p></div></div><div class="code"><div class="wrapper">        context.stop(sender())
        childCount -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> (childCount &lt;= <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if we don&#39;t have anymore work and all sort workers are done, we are DONE!, shutdown the system</p></div></div><div class="code"><div class="wrapper">          log.info(<span class="hljs-string">"DONE SORTING"</span>)
          context.system.shutdown()
        }
      }
  }
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">SorterActor</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>define an ordering for DateTime, found on stackoverflow</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">implicit</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">JodaDateTimeOrdering</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">Ordering</span>[</span><span class="hljs-type">DateTime</span>] {
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">dtComparer</span> =</span> <span class="hljs-type">DateTimeComparator</span>.getInstance()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare</span>(</span>x: <span class="hljs-type">DateTime</span>, y: <span class="hljs-type">DateTime</span>): <span class="hljs-type">Int</span> = {
      dtComparer.compare(x, y)
    }
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>the sorting worker. Each actor runs in parallel and will merge a set of files for one
specific user before asking for more work from the manager.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SorterWorkerActor</span>(</span>args: <span class="hljs-type">LogSplitAppArgs</span>) <span class="hljs-keyword">extends</span> <span class="hljs-type">Actor</span> <span class="hljs-keyword">with</span> <span class="hljs-type">ActorLogging</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>first of all, ask for work when we are ready</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">preStart</span>(</span>): <span class="hljs-type">Unit</span> = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>pull work from parent when ready</p></div></div><div class="code"><div class="wrapper">      context.parent ! <span class="hljs-type">GiveMeWork</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span>:</span> <span class="hljs-type">Actor</span>.<span class="hljs-type">Receive</span> = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>receive workload</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">case</span> <span class="hljs-type">SortUser</span>(userid, files) =&gt;
        log.debug(<span class="hljs-string">"sorting for {}"</span>, userid)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>part files are already ordered for each server, just append them in order of partID</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">serverParts</span>:</span> <span class="hljs-type">Seq</span>[<span class="hljs-type">Iterator</span>[<span class="hljs-type">String</span>]] = files.groupBy(_.serverId).values.toSeq.map {
          parts =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">JoinIterators</span>(parts.sortBy(_.partId).map(_.file))
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>server inputs are sorted, but not relative to other server parts
use the LineSorter iterator to merge them and get the lines in order.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">inputIterator</span>:</span> <span class="hljs-type">Iterator</span>[<span class="hljs-type">String</span>] = <span class="hljs-keyword">new</span> <span class="hljs-type">LineSorter</span>(serverParts, <span class="hljs-type">Parser</span>.extractDate)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>all the sorting work is done by the iterator, we just need to print them out</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">writer</span> =</span> <span class="hljs-keyword">new</span> <span class="hljs-type">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(args.output, userid))
        <span class="hljs-keyword">try</span> {
          inputIterator.foreach(writer.println)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>maybe delete the part files (do not delete if there was an exception)</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">if</span> (args.deletePartFiles) {
            files.foreach {
              f =&gt;
                f.file.delete()
            }
          }
          log.debug(<span class="hljs-string">"done sorting for {}"</span>, userid)
        } <span class="hljs-keyword">catch</span> {
          <span class="hljs-keyword">case</span> <span class="hljs-type">NonFatal</span>(e) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>something wrong happened, just give up on that user and try another one</p></div></div><div class="code"><div class="wrapper">            log.error(e, <span class="hljs-string">"failed sorting for {}"</span>, userid)
        } <span class="hljs-keyword">finally</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>close the writer</p></div></div><div class="code"><div class="wrapper">          writer.close()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ask the parent sorter for work</p></div></div><div class="code"><div class="wrapper">          context.parent ! <span class="hljs-type">GiveMeWork</span>
        }
    }
  }
}</div></div></div></div></body></html>