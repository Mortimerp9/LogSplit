<!DOCTYPE html><html lang="en"><head><title>main/scala/net/pierreandrews/LogSplitApp</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="main/scala/net/pierreandrews/LogSplitApp"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/LogSplitApp.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/LogSplitApp.scala">src/main/scala/net/pierreandrews/LogSplitApp.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper">package net.pierreandrews

<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> java.io.{ FilenameFilter, File }</span>

<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> akka.actor.{ Props, ActorSystem }</span>
<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> com.quantifind.sumac.validation.{ Positive, Required }</span>
<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> com.quantifind.sumac.{ FieldArgs, ArgMain }</span>
<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> com.typesafe.config.ConfigFactory</span>
<span class="hljs-preprocessor"><span class="hljs-keyword">import</span> net.pierreandrews.utils.LogSplitUtils</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The main application that runs on one server. This will initialize the actor system on
 the current server and setup the cluster properties.</p>
<p>See <code>LogSplitApp --help</code> and LogSplitAppArgs to see the valid and required command line arguments.
 The default is to run on a localhost cluster, where we have a node at localhost:2550, localhost:2551 and
 localhost:2552. You should start at least three JVMs one these ports (using --port 2550, etc.). You
 can run the node on separate machines, then you have to specify --seeds to point to the other machines, or update
 application.conf</p>
<p>User: pierre
Date: 11/28/14</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">LogSplitApp</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">ArgMain</span>[</span><span class="hljs-type">LogSplitAppArgs</span>] {
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(</span>args: <span class="hljs-type">LogSplitAppArgs</span>): <span class="hljs-type">Unit</span> = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>setup the actorsystem and cluster connection</p></div></div><div class="code"><div class="wrapper">    val config = ConfigFactory.<span class="hljs-function"><span class="hljs-title">parseString</span><span class="hljs-params">(s<span class="hljs-string">"akka.remote.netty.tcp.port=${args.port}"</span>)</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if we have a set of seeds on the command line</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">configWithSeeds</span> =</span> args.seeds.map { seedSeq =&gt;
      <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">seedStr</span> =</span> seedSeq.map(ip =&gt; s<span class="hljs-string">"""akka.tcp://ClusterSystem@$ip"""</span>).mkString(<span class="hljs-string">","</span>)
      config.withFallback(<span class="hljs-type">ConfigFactory</span>.parseString(s<span class="hljs-string">"akka.cluster.seed-nodes=[$seedStr]"</span>))
    }.getOrElse(config)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and finally load application.conf and co</p></div></div><div class="code"><div class="wrapper">      .<span class="hljs-function"><span class="hljs-title">withFallback</span><span class="hljs-params">(ConfigFactory.load()</span></span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>start the system</p></div></div><div class="code"><div class="wrapper">    val system = <span class="hljs-function"><span class="hljs-title">ActorSystem</span><span class="hljs-params">(s<span class="hljs-string">"ClusterSystem"</span>, configWithSeeds)</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>setup some file readers</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-title">startReaders</span><span class="hljs-params">(args, system)</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>setup the sorter manager for this node</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">sorter</span> =</span> system.actorOf(<span class="hljs-type">Props</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">SorterActor</span>(args)), name = <span class="hljs-string">"sorter"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>setup the writer manager for this node</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">system</span>.actorOf(Props(<span class="hljs-keyword">new</span> WriterActor(<span class="hljs-keyword">args</span>, sorter)), name = <span class="hljs-string">"writer"</span>)

  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we assume that the log files are split in buckets and follow this naming pattern (see below)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">validLogFile</span> =</span> <span class="hljs-string">".[0-9]+.log$"</span>.r</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>setup the reader workers</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startReaders</span><span class="hljs-params">(args: LogSplitAppArgs, system: ActorSystem)</span>:</span> Unit = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>listFiles might return null, wrap in Option</p></div></div><div class="code"><div class="wrapper">    val files: Se<span class="hljs-string">q[File]</span> = Option(args.input.listFiles(new FilenameFilter {
      override def <span class="hljs-keyword">accept</span>(dir: File, name: String): Boolean = <span class="hljs-keyword">return</span> validLogFile.findFirstIn(name).isDefined
    })).<span class="hljs-keyword">map</span>(<span class="hljs-number">_</span>.toSeq)
      .getOrElse(Se<span class="hljs-string">q()</span>)
      .sortBy { <span class="hljs-string">file =&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we assume that log files will have the form: filename.NUMBER.log
and that filename.0.log has more recent logs than filename.1.log, etc.
(this is a bit naive maybe)</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">name</span> =</span> file.getName
        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">dotIdx</span> =</span> name.indexOf('.')
        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">secondDot</span> =</span> name.indexOf('.', dotIdx + <span class="hljs-number">1</span>)
        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">partID</span> =</span> name.substring(dotIdx + <span class="hljs-number">1</span>, secondDot)
        partID.toInt
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>distribute the input files between each workers
zipWithIndex assignes them an id</p></div></div><div class="code"><div class="wrapper">    val readerSplit = LogSplitUtils.cut(<span class="hljs-built_in">files</span>, args.numReaderWorkers).toSeq
    readerSplit.zipWithIndex.foreach {
      <span class="hljs-keyword">case</span> (<span class="hljs-built_in">files</span>, partIdx) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>for each input split, start a reader that will read the files in
parallel</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-built_in">system</span>.actorOf(Props(<span class="hljs-keyword">new</span> ReaderActor(<span class="hljs-keyword">args</span>, <span class="hljs-keyword">files</span>, partIdx, readerSplit.size)), name = <span class="hljs-keyword">s</span><span class="hljs-string">"reader-$partIdx"</span>)
    }
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Command line argument definition, using Sumac.</p>
<p>This settings are local to a node/server.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogSplitAppArgs</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">FieldArgs</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The id of the server, this is required
the ID has to be positive and is used to assign users to
this server (partition)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Required</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">serverID</span>: Int = -<span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>What port are we running in.
It is important that this corresponds to the settings in application.conf
 or provided by --seeds</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-tag">var</span> port: Int = <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Where are we reading the logs from</p></div></div><div class="code"><div class="wrapper">  @Required
  <span class="hljs-tag">var</span> <span class="hljs-tag">input</span>: File = _</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Where the files going to be output
part files go here too</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Required</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">output</span>: File = _</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>How many servers are there.
This is set to default to 3.
It is important that this is accurate as it is used to assign users to partitions.
Each node in the cluster should be configured with the same numServers</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">numServers</span>: Int = <span class="hljs-number">3</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>How many writer workers do we want on this server</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">numWriteWorkers</span>: Int = <span class="hljs-number">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>how many file handles should EACH writer worker keep cached. See the WriterWorkerActor for more details</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">maxWriteOpen</span>: Int = <span class="hljs-number">20</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>How many reader workers do we want on this server?</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">numReaderWorkers</span>: Int = <span class="hljs-number">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We buffer log lines in memory,
this is useful to unblock reads when a particular partition is slower than another one
a higher value should increase the throughput but will require more memory.
Each reader will load that amount of lines for each partition in memory, so the actual lines
in memory will be potentially = numReaderWorkers<em>numServers</em>maxReadBuffer</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">maxReadBuffer</span>: Int = <span class="hljs-number">10000</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Once the log distribution is done, we are left with a number of part files coming from each server
each part file is sorted but all the parts are not globally sorted. Once we are done collecting logs,
we have to sort the lines again. How many parallel sorters should we use.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-property">@Positive</span>
  <span class="hljs-reserved">var</span> <span class="hljs-attribute">numSortWorkers</span>: Int = <span class="hljs-number">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Should we delete the partially sorted part files when we are done.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> deletePartFiles: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>settings for the cluster seeds. The defaults are set in application.conf. This has to be specified as a list of string IP with port:
e.g. --seeds 192.168.0.1:2550,192.168.0.2:2551,192.168.0.30:2552
at least one seed should be setup, the other nodes should be able to auto-discover each other from this.</p></div></div><div class="code"><div class="wrapper">  var seeds: Option[Se<span class="hljs-string">q[String]</span>] = None

  addValidation {
    <span class="hljs-keyword">require</span>(port &gt;= <span class="hljs-number">0</span>, <span class="hljs-string">"port cannot be negative"</span>)
    <span class="hljs-keyword">require</span>(serverID &gt;= <span class="hljs-number">0</span>, <span class="hljs-string">"serverID cannot be negative"</span>)
  }

}</div></div></div></div></body></html>