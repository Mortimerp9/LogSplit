<!DOCTYPE html><html lang="en"><head><title>LogSplitApp</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="LogSplitApp"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/LogSplitApp.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/LogSplitApp.scala">src/main/scala/net/pierreandrews/LogSplitApp.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">package</span> <span class="nn">net.pierreandrews</span>

<span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span> <span class="nc">FilenameFilter</span><span class="o">,</span> <span class="nc">File</span> <span class="o">}</span>

<span class="k">import</span> <span class="nn">akka.actor.</span><span class="o">{</span> <span class="nc">Props</span><span class="o">,</span> <span class="nc">ActorSystem</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">com.quantifind.sumac.validation.</span><span class="o">{</span> <span class="nc">Positive</span><span class="o">,</span> <span class="nc">Required</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">com.quantifind.sumac.</span><span class="o">{</span> <span class="nc">FieldArgs</span><span class="o">,</span> <span class="nc">ArgMain</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">com.typesafe.config.ConfigFactory</span>
<span class="k">import</span> <span class="nn">net.pierreandrews.utils.LogSplitUtils</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="the-main-application">The Main Application</h1>
<p>This will run on each single server; it will initialize the actor system on
 the current server and setup the cluster properties.</p>
<p>See <code>LogSplitApp --help</code> and LogSplitAppArgs to see the valid and required command line arguments.
 The default is to run on a localhost cluster, where we have a node at <code>localhost:2550</code>, <code>localhost:2551</code> and
 <code>localhost:2552</code>. You should start at least three JVMs one these ports (using <code>--port 2550</code>, etc.). You
 can run the node on separate machines, then you have to specify <code>--seeds</code> to point to the other machines, or update
 <code>application.conf</code></p>
<p>User: pierre
Date: 11/28/14</p></div></div><div class="code"><div class="wrapper"><span class="k">object</span> <span class="nc">LogSplitApp</span> <span class="k">extends</span> <span class="nc">ArgMain</span><span class="o">[</span><span class="kt">LogSplitAppArgs</span><span class="o">]</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we assume that the log files are split in buckets and follow this naming pattern (see below)</p></div></div><div class="code"><div class="wrapper">  <span class="k">private</span> <span class="k">final</span> <span class="k">val</span> <span class="n">validLogFile</span> <span class="k">=</span> <span class="s">&quot;.[0-9]+.log$&quot;</span><span class="o">.</span><span class="n">r</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">LogSplitAppArgs</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="setup-the-actorsystem-and-cluster-connection">setup the actorsystem and cluster connection</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">parseString</span><span class="o">(</span><span class="s">s&quot;akka.remote.netty.tcp.port=</span><span class="si">${</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if we have a set of seeds on the command line</p></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">configWithSeeds</span> <span class="k">=</span> <span class="n">args</span><span class="o">.</span><span class="n">seeds</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">seedSeq</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">seedStr</span> <span class="k">=</span> <span class="n">seedSeq</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">ip</span> <span class="k">=&gt;</span> <span class="s">s&quot;&quot;&quot;akka.tcp://ClusterSystem@</span><span class="si">$ip</span><span class="s">&quot;&quot;&quot;</span><span class="o">).</span><span class="n">mkString</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
      <span class="n">config</span><span class="o">.</span><span class="n">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">parseString</span><span class="o">(</span><span class="s">s&quot;akka.cluster.seed-nodes=[</span><span class="si">$seedStr</span><span class="s">]&quot;</span><span class="o">))</span>
    <span class="o">}.</span><span class="n">getOrElse</span><span class="o">(</span><span class="n">config</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>and finally load application.conf and the configuration stack
as defined by <a href="https://github.com/typesafehub/config/blob/master/HOCON.md">HOCON</a></p></div></div><div class="code"><div class="wrapper">      <span class="o">.</span><span class="n">withFallback</span><span class="o">(</span><span class="nc">ConfigFactory</span><span class="o">.</span><span class="n">load</span><span class="o">())</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="start-the-system">start the system</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">s&quot;ClusterSystem&quot;</span><span class="o">,</span> <span class="n">configWithSeeds</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="start-some-actors">start some actors</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>setup some file readers</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="n">startReaders</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="n">system</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>setup the sorter manager for this node</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">sorter</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">SorterActor</span><span class="o">(</span><span class="n">args</span><span class="o">)),</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;sorter&quot;</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>setup the writer manager for this node</li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">WriterActor</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="n">sorter</span><span class="o">)),</span> <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;writer&quot;</span><span class="o">)</span>

  <span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="setup-the-reader-workers">setup the reader workers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="k">def</span> <span class="n">startReaders</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">LogSplitAppArgs</span><span class="o">,</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>listFiles</code> might return <code>null</code>, wrap in <code>Option</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">files</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">File</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="nc">FilenameFilter</span> <span class="o">{</span>
      <span class="k">override</span> <span class="k">def</span> <span class="n">accept</span><span class="o">(</span><span class="n">dir</span><span class="k">:</span> <span class="kt">File</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="k">return</span> <span class="n">validLogFile</span><span class="o">.</span><span class="n">findFirstIn</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="n">isDefined</span>
    <span class="o">})).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toSeq</span><span class="o">)</span>
      <span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">Seq</span><span class="o">())</span>
      <span class="o">.</span><span class="n">sortBy</span> <span class="o">{</span> <span class="n">file</span> <span class="k">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>we assume that log files will have the form: filename.NUMBER.log
and that filename.0.log has more recent logs than filename.1.log, etc.
(this is a bit naive maybe)</p></div></div><div class="code"><div class="wrapper">        <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">file</span><span class="o">.</span><span class="n">getName</span>
        <span class="k">val</span> <span class="n">dotIdx</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">indexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">secondDot</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">indexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="n">dotIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">partID</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="n">dotIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">secondDot</span><span class="o">)</span>
        <span class="n">partID</span><span class="o">.</span><span class="n">toInt</span>
      <span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>distribute the input files between each workers
zipWithIndex assignes them an id</p></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">readerSplit</span> <span class="k">=</span> <span class="nc">LogSplitUtils</span><span class="o">.</span><span class="n">cut</span><span class="o">(</span><span class="n">files</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="n">numReaderWorkers</span><span class="o">).</span><span class="n">toSeq</span>
    <span class="n">readerSplit</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">files</span><span class="o">,</span> <span class="n">partIdx</span><span class="o">)</span> <span class="k">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>for each input split, start a reader that will read the files in
parallel</p></div></div><div class="code"><div class="wrapper">        <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">ReaderActor</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="n">files</span><span class="o">,</span> <span class="n">partIdx</span><span class="o">,</span> <span class="n">readerSplit</span><span class="o">.</span><span class="n">size</span><span class="o">)),</span> <span class="n">name</span> <span class="k">=</span> <span class="s">s&quot;reader-</span><span class="si">$partIdx</span><span class="s">&quot;</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="command-line-argument-definition-using-sumac-https-github-com-quantifind-sumac-">Command line argument definition, using <a href="https://github.com/quantifind/Sumac">Sumac</a>.</h1>
<p>These settings are local to a node/server.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nc">LogSplitAppArgs</span> <span class="k">extends</span> <span class="nc">FieldArgs</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>The id of the server, this is required
the ID has to be positive and is used to assign users to
this server (partition)</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Required</span>
  <span class="k">var</span> <span class="n">serverID</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>What port are we running in.
It is important that this corresponds to the settings in application.conf
or provided by <code>--seeds</code></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="k">var</span> <span class="n">port</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Where are we reading the logs from</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Required</span>
  <span class="k">var</span> <span class="n">input</span><span class="k">:</span> <span class="kt">File</span> <span class="o">=</span> <span class="k">_</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Where the files going to be output
part files go here too</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Required</span>
  <span class="k">var</span> <span class="n">output</span><span class="k">:</span> <span class="kt">File</span> <span class="o">=</span> <span class="k">_</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>How many servers are there.
This is set to default to 3.
It is important that this is accurate as it is used to assign users to partitions.
Each node in the cluster should be configured with the same <code>numServers</code></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numServers</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">3</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>How many writer workers do we want on this server</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numWriteWorkers</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>How many file handles should EACH writer worker keep cached. See the <code>WriterWorkerActor</code> for more details</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">maxWriteOpen</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">20</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>How many reader workers do we want on this server?</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numReaderWorkers</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>We buffer log lines in memory,
this is useful to unblock reads when a particular partition is slower than another one
a higher value should increase the throughput but will require more memory.
Each reader will load that amount of lines for each partition in memory, so the actual lines
in memory will be potentially equal to <code>numReaderWorkers * numServers*maxReadBuffer</code></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">maxReadBuffer</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10000</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Once the log distribution is done, we are left with a number of part files coming from each server
each part file is sorted but all the parts are not globally sorted. Once we are done collecting logs,
we have to sort the lines again. How many parallel sorters should we use.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numSortWorkers</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">60</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Should we delete the partially sorted part files when we are done?</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="k">var</span> <span class="n">deletePartFiles</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Settings for the cluster seeds. The defaults are set in <code>application.conf</code>. This has to be specified as a list of string IP with port:
e.g. <code>--seeds 192.168.0.1:2550,192.168.0.2:2551,192.168.0.30:2552</code>
at least one seed should be setup, the other nodes should be able to auto-discover each other from this.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="k">var</span> <span class="n">seeds</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">None</span>

  <span class="n">addValidation</span> <span class="o">{</span>
    <span class="n">require</span><span class="o">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;port cannot be negative&quot;</span><span class="o">)</span>
    <span class="n">require</span><span class="o">(</span><span class="n">serverID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;serverID cannot be negative&quot;</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span></div></div></div></div></body></html>