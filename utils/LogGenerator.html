<!DOCTYPE html><html lang="en"><head><title>utils/LogGenerator</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="utils/LogGenerator"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/utils/LogGenerator.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/utils/LogGenerator.scala">src/main/scala/net/pierreandrews/utils/LogGenerator.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">package</span> <span class="nn">net.pierreandrews.utils</span>

<span class="k">import</span> <span class="nn">java.io.</span><span class="o">{</span><span class="nc">File</span><span class="o">,</span> <span class="nc">PrintWriter</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">java.text.SimpleDateFormat</span>
<span class="k">import</span> <span class="nn">java.util.</span><span class="o">{</span><span class="nc">Date</span><span class="o">,</span> <span class="nc">UUID</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.util.Random</span>
<span class="k">import</span> <span class="nn">scala.util.control.NonFatal</span>

<span class="k">import</span> <span class="nn">com.quantifind.sumac.</span><span class="o">{</span><span class="nc">ArgMain</span><span class="o">,</span> <span class="nc">FieldArgs</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.quantifind.sumac.validation.</span><span class="o">{</span><span class="nc">Positive</span><span class="o">,</span> <span class="nc">Required</span><span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Generate sample logs. This is pretty naive but tries to generate logs looking like the instruction, with other assumptions:</p>
<ul>
<li>log files are in buckets and not in one monolithic file</li>
<li>each bucket is sorted, with the top line having the max date and bottom line the min date</li>
<li>each bucket is numbered from 0 to N, bucket 0 has the max date at the top, the N bucket as the min date at the bottom</li>
<li>buckets are named with the pattern log.X.log</li>
</ul>
<p>See LogGenArgs for possible command line arguments.</p>
<p>Random noise is generated to create invalid lines (again, naively truncates the end of some lines)</p>
<p>Dates are generated from now in a decreasing order, at random distances one from the other (but always going towards the
past).</p>
<p>We assume a limited set of user ids (to have log lines to group), you can specify this on the command line. Then each log
line is assigned a random user from this limited set, this means that at the end, you might have less users in the generated
logs than requested.</p>
<p>User: pierre
Date: 11/28/14</p></div></div><div class="code"><div class="wrapper"><span class="k">object</span> <span class="nc">LogGenerator</span> <span class="k">extends</span> <span class="nc">ArgMain</span><span class="o">[</span><span class="kt">LogGenArgs</span><span class="o">]</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate dates of the format: 15/Aug/2013:13:54:38 -0300</p></div></div><div class="code"><div class="wrapper">  <span class="k">val</span> <span class="n">dateformat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">&quot;dd/MMM/YYYY:HH:mm:ss Z&quot;</span><span class="o">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate random sequential timestamps. Start now and goes backward. This will break if you
really ask for too many timestamps and go past the 0 epoch</p></div></div><div class="code"><div class="wrapper">  <span class="k">def</span> <span class="n">tsGenerator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Iterator</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span> <span class="o">{</span> <span class="n">previousTS</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">dec</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">3600</span><span class="o">)</span> <span class="o">*</span> <span class="mi">1000L</span>
    <span class="n">previousTS</span> <span class="o">-</span> <span class="n">dec</span>
  <span class="o">}.</span><span class="n">map</span> <span class="o">{</span> <span class="n">ts</span> <span class="k">=&gt;</span>
    <span class="n">dateformat</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">ts</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">LogGenArgs</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate a fixed number of user ids and repeat it randomly</p></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">uids</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">0</span> <span class="n">until</span> <span class="n">args</span><span class="o">.</span><span class="n">numUsers</span><span class="o">)</span> <span class="k">yield</span> <span class="o">{</span> <span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">().</span><span class="n">toString</span> <span class="o">}</span>
      <span class="nc">Iterator</span><span class="o">.</span><span class="n">continually</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">randIdx</span> <span class="k">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="n">ids</span><span class="o">.</span><span class="n">size</span><span class="o">)</span>
        <span class="n">ids</span><span class="o">(</span><span class="n">randIdx</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>randomly generate errors in the logs</p></div></div><div class="code"><div class="wrapper">    <span class="k">def</span> <span class="n">makeError</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextDouble</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="n">errorRate</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>list of dirs to output to, one per server</p></div></div><div class="code"><div class="wrapper">    <span class="k">val</span> <span class="n">outputDirs</span> <span class="k">=</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">args</span><span class="o">.</span><span class="n">numServers</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span> <span class="n">serverID</span> <span class="k">=&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>these are generated locally, if you want to simulate on separate physical
servers, you&#39;ll have to copy the files over</p></div></div><div class="code"><div class="wrapper">      <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="o">,</span> <span class="s">s&quot;server</span><span class="si">$serverID</span><span class="s">&quot;</span><span class="o">)</span>
    <span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>create logs for each server</p></div></div><div class="code"><div class="wrapper">    <span class="n">outputDirs</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
      <span class="n">dir</span> <span class="k">=&gt;</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">dir</span><span class="o">.</span><span class="n">exists</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">dir</span><span class="o">.</span><span class="n">mkdir</span><span class="o">()</span>
        <span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get a new timestamp generator</p></div></div><div class="code"><div class="wrapper">        <span class="k">val</span> <span class="n">tsGen</span> <span class="k">=</span> <span class="n">tsGenerator</span><span class="o">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>open N files and write to them</p></div></div><div class="code"><div class="wrapper">        <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">args</span><span class="o">.</span><span class="n">numFiles</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span>
          <span class="n">fileID</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">file</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">dir</span><span class="o">,</span> <span class="s">s&quot;log.</span><span class="si">$fileID</span><span class="s">.log&quot;</span><span class="o">))</span>
            <span class="k">try</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate M lines per file</p></div></div><div class="code"><div class="wrapper">              <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">args</span><span class="o">.</span><span class="n">linePerFile</span><span class="o">).</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">l</span> <span class="k">=&gt;</span>
                <span class="k">val</span> <span class="n">ts</span> <span class="k">=</span> <span class="n">tsGen</span><span class="o">.</span><span class="n">next</span><span class="o">()</span>
                <span class="k">val</span> <span class="n">uid</span> <span class="k">=</span> <span class="n">uids</span><span class="o">.</span><span class="n">next</span><span class="o">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>except for the date and userid, the rest of the line content is the same</p></div></div><div class="code"><div class="wrapper">                <span class="k">val</span> <span class="n">line</span> <span class="k">=</span> <span class="s">s&quot;&quot;&quot;177.126.180.83 - - [</span><span class="si">$ts</span><span class="s">] &quot;GET /meme.jpg HTTP/1.1&quot; 200 2148 &quot;-&quot; &quot;userid=</span><span class="si">$uid</span><span class="s">&quot;&quot;&quot;&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>maybe create som error</p></div></div><div class="code"><div class="wrapper">                <span class="k">val</span> <span class="n">outline</span> <span class="k">=</span> <span class="k">if</span><span class="o">(</span><span class="n">makeError</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">line</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="n">length</span><span class="o">)+</span><span class="mi">1</span><span class="o">)</span>
                <span class="o">}</span> <span class="k">else</span> <span class="n">line</span>
                <span class="n">file</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">outline</span><span class="o">)</span>
              <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
              <span class="k">case</span> <span class="nc">NonFatal</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span>
                <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="o">()</span>
                <span class="nc">System</span><span class="o">.</span><span class="n">exit</span><span class="o">(-</span><span class="mi">1</span><span class="o">)</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="o">()</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

  <span class="o">}</span>

<span class="o">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>command line arguments, using Sumac</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nc">LogGenArgs</span> <span class="k">extends</span> <span class="nc">FieldArgs</span> <span class="o">{</span>

  <span class="nd">@Required</span>
  <span class="k">var</span> <span class="n">output</span><span class="k">:</span> <span class="kt">File</span> <span class="o">=</span> <span class="k">_</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>sets the number of output folders</p></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numServers</span> <span class="k">=</span> <span class="mi">3</span>
  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">linePerFile</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1000</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>number of buckets</p></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numFiles</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">10</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>how often should an error be generated</p></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">errorRate</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.001</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>how many different users do we want</p></div></div><div class="code"><div class="wrapper">  <span class="nd">@Positive</span>
  <span class="k">var</span> <span class="n">numUsers</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">100</span>

  <span class="n">addValidation</span> <span class="o">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>validate the output directory.</p></div></div><div class="code"><div class="wrapper">    <span class="n">require</span><span class="o">(</span><span class="n">output</span><span class="o">.</span><span class="n">exists</span> <span class="o">&amp;&amp;</span> <span class="n">output</span><span class="o">.</span><span class="n">isDirectory</span> <span class="o">&amp;&amp;</span> <span class="n">output</span><span class="o">.</span><span class="n">listFiles</span><span class="o">().</span><span class="n">isEmpty</span><span class="o">,</span> <span class="s">&quot;Output has to be an empty directory&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></div></div></div></div></body></html>