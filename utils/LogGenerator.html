<!DOCTYPE html><html lang="en"><head><title>utils/LogGenerator</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="utils/LogGenerator"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/utils/LogGenerator.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/utils/LogGenerator.scala">src/main/scala/net/pierreandrews/utils/LogGenerator.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">package</span> net.pierreandrews.utils

<span class="hljs-keyword">import</span> java.io.{<span class="hljs-type">File</span>, <span class="hljs-type">PrintWriter</span>}
<span class="hljs-keyword">import</span> java.text.<span class="hljs-type">SimpleDateFormat</span>
<span class="hljs-keyword">import</span> java.util.{<span class="hljs-type">Date</span>, <span class="hljs-type">UUID</span>}

<span class="hljs-keyword">import</span> scala.util.<span class="hljs-type">Random</span>
<span class="hljs-keyword">import</span> scala.util.control.<span class="hljs-type">NonFatal</span>

<span class="hljs-keyword">import</span> com.quantifind.sumac.{<span class="hljs-type">ArgMain</span>, <span class="hljs-type">FieldArgs</span>}
<span class="hljs-keyword">import</span> com.quantifind.sumac.validation.{<span class="hljs-type">Positive</span>, <span class="hljs-type">Required</span>}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Generate sample logs. This is pretty naive but tries to generate logs looking like the instruction, with other assumptions:</p>
<ul>
<li>log files are in buckets and not in one monolithic file</li>
<li>each bucket is sorted, with the top line having the max date and bottom line the min date</li>
<li>each bucket is numbered from 0 to N, bucket 0 has the max date at the top, the N bucket as the min date at the bottom</li>
<li>buckets are named with the pattern log.X.log</li>
</ul>
<p>See LogGenArgs for possible command line arguments.</p>
<p>Random noise is generated to create invalid lines (again, naively truncates the end of some lines)</p>
<p>Dates are generated from now in a decreasing order, at random distances one from the other (but always going towards the
past).</p>
<p>We assume a limited set of user ids (to have log lines to group), you can specify this on the command line. Then each log
line is assigned a random user from this limited set, this means that at the end, you might have less users in the generated
logs than requested.</p>
<p>User: pierre
Date: 11/28/14</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">LogGenerator</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">ArgMain</span>[</span><span class="hljs-type">LogGenArgs</span>] {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate dates of the format: 15/Aug/2013:13:54:38 -0300</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">dateformat</span> =</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleDateFormat</span>(<span class="hljs-string">"dd/MMM/YYYY:HH:mm:ss Z"</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate random sequential timestamps. Start now and goes backward. This will break if you
really ask for too many timestamps and go past the 0 epoch</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tsGenerator</span>(</span>): <span class="hljs-type">Iterator</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">Iterator</span>.iterate(<span class="hljs-type">System</span>.currentTimeMillis) { previousTS =&gt;
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">dec</span> =</span> <span class="hljs-type">Random</span>.nextInt(<span class="hljs-number">3600</span>) * <span class="hljs-number">1000</span>L
    previousTS - dec
  }.map { ts =&gt;
    dateformat.format(<span class="hljs-keyword">new</span> <span class="hljs-type">Date</span>(ts))
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(</span>args: <span class="hljs-type">LogGenArgs</span>): <span class="hljs-type">Unit</span> = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate a fixed number of user ids and repeat it randomly</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">uids</span>:</span> <span class="hljs-type">Iterator</span>[<span class="hljs-type">String</span>] = {
      <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">ids</span>:</span> <span class="hljs-type">Seq</span>[<span class="hljs-type">String</span>] = <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until args.numUsers) <span class="hljs-keyword">yield</span> { <span class="hljs-type">UUID</span>.randomUUID().toString }
      <span class="hljs-type">Iterator</span>.continually {
        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">randIdx</span> =</span> <span class="hljs-type">Random</span>.nextInt(ids.size)
        ids(randIdx)
      }
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>randomly generate errors in the logs</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makeError</span>:</span> <span class="hljs-type">Boolean</span> = <span class="hljs-type">Random</span>.nextDouble() &lt; args.errorRate</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>list of dirs to output to, one per server</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">outputDirs</span> =</span> (<span class="hljs-number">0</span> until args.numServers).map { serverID =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>these are generated locally, if you want to simulate on separate physical
servers, you&#39;ll have to copy the files over</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(args.output, s<span class="hljs-string">"server$serverID"</span>)
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>create logs for each server</p></div></div><div class="code"><div class="wrapper">    outputDirs.foreach {
      dir =&gt;
        <span class="hljs-keyword">if</span>(!dir.exists) {
          dir.mkdir()
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get a new timestamp generator</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">tsGen</span> =</span> tsGenerator()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>open N files and write to them</p></div></div><div class="code"><div class="wrapper">        (<span class="hljs-number">0</span> until args.numFiles).foreach {
          fileID =&gt;
            <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">file</span> =</span> <span class="hljs-keyword">new</span> <span class="hljs-type">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(dir, s<span class="hljs-string">"log.$fileID.log"</span>))
            <span class="hljs-keyword">try</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>generate M lines per file</p></div></div><div class="code"><div class="wrapper">              (<span class="hljs-number">0</span> until args.linePerFile).foreach { l =&gt;
                <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">ts</span> =</span> tsGen.next()
                <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">uid</span> =</span> uids.next()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>except for the date and userid, the rest of the line content is the same</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">line</span> =</span> s<span class="hljs-string">"""177.126.180.83 - - [$ts] "GET /meme.jpg HTTP/1.1" 200 2148 "-" "userid=$uid"""</span><span class="hljs-string">"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>maybe create som error</p></div></div><div class="code"><div class="wrapper">                <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">outline</span> =</span> <span class="hljs-keyword">if</span>(makeError) {
                  line.substring(<span class="hljs-number">0</span>, <span class="hljs-type">Random</span>.nextInt(line.length)+<span class="hljs-number">1</span>)
                } <span class="hljs-keyword">else</span> line
                file.println(outline)
              }
            } <span class="hljs-keyword">catch</span> {
              <span class="hljs-keyword">case</span> <span class="hljs-type">NonFatal</span>(e) =&gt;
                e.printStackTrace()
                <span class="hljs-type">System</span>.exit(-<span class="hljs-number">1</span>)
            } <span class="hljs-keyword">finally</span> {
              file.close()
            }
        }

    }

  }

}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>command line arguments, using Sumac</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogGenArgs</span> <span class="hljs-keyword"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">FieldArgs</span> {</span>

  <span class="hljs-annotation">@Required</span>
  <span class="hljs-keyword">var</span> output: <span class="hljs-type">File</span> = _</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>sets the number of output folders</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-annotation">@Positive</span>
  <span class="hljs-keyword">var</span> numServers = <span class="hljs-number">3</span>
  <span class="hljs-annotation">@Positive</span>
  <span class="hljs-keyword">var</span> linePerFile: <span class="hljs-type">Int</span> = <span class="hljs-number">1000</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>number of buckets</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-annotation">@Positive</span>
  <span class="hljs-keyword">var</span> numFiles: <span class="hljs-type">Int</span> = <span class="hljs-number">10</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>how often should an error be generated</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-annotation">@Positive</span>
  <span class="hljs-keyword">var</span> errorRate: <span class="hljs-type">Double</span> = <span class="hljs-number">0.001</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>how many different users do we want</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-annotation">@Positive</span>
  <span class="hljs-keyword">var</span> numUsers: <span class="hljs-type">Int</span> = <span class="hljs-number">100</span>

  addValidation {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>validate the output directory.</p></div></div><div class="code"><div class="wrapper">    require(output.exists &amp;&amp; output.isDirectory &amp;&amp; output.listFiles().isEmpty, <span class="hljs-string">"Output has to be an empty directory"</span>)
  }
}</div></div></div></div></body></html>