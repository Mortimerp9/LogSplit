<!DOCTYPE html><html lang="en"><head><title>WriterActor</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="WriterActor"><meta name="groc-project-path" content="src/main/scala/net/pierreandrews/WriterActor.scala"><meta name="groc-github-url" content="https://github.com/Mortimerp9/LogSplit"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/Mortimerp9/LogSplit/blob/master/src/main/scala/net/pierreandrews/WriterActor.scala">src/main/scala/net/pierreandrews/WriterActor.scala</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">package</span> net.pierreandrews

<span class="hljs-keyword">import</span> akka.actor._
<span class="hljs-keyword">import</span> akka.event.<span class="hljs-type">LoggingReceive</span>
<span class="hljs-keyword">import</span> net.pierreandrews.<span class="hljs-type">Protocol</span>._</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The main writer work manager. There is one WriterActor per server and it creates a number
 of workers. Each worker is responsible for a number of files, as decided by the reader&#39;s part id.</p>
<p> Each worker runs in parallel and is responsible for files that no one else will write to.</p>
<p> The writers are not aware of the cluster, they just receive registration from the readers and don&#39;t really care where
 they live. The readers could be reading files locally or on another server.</p>
<p>User: pierre
Date: 11/29/14</p></div></div><div class="code"><div class="wrapper"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WriterActor</span>(</span>args: <span class="hljs-type">LogSplitAppArgs</span>, sorter: <span class="hljs-type">ActorRef</span>) <span class="hljs-keyword">extends</span> <span class="hljs-type">Actor</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>start a set of worker and watch them, when they get terminated, we know that we are 
done with all writes</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">workers</span>:</span> <span class="hljs-type">IndexedSeq</span>[<span class="hljs-type">ActorRef</span>] = <span class="hljs-keyword">for</span> { i &lt;- <span class="hljs-number">0</span> until args.numWriteWorkers } <span class="hljs-keyword">yield</span> {
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">child</span> =</span> context.actorOf(<span class="hljs-type">Props</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">WriterWorkerActor</span>(args, i)), s<span class="hljs-string">"writer-$i"</span>)
    context.watch(child)
    child
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>count the number of workers that are done (all their readers have emptied their files)</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">var</span> doneWorkers: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For each server, keep track of the number of readers that will register with us. This
allows the writer to know when the cluster is all up and it can start pulling work
from the readers.</p>
<p>Each cell corresponds to one server.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">awaitReaders</span>:</span> <span class="hljs-type">Array</span>[<span class="hljs-type">Int</span>] = {
    <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">seq</span> =</span> <span class="hljs-keyword">new</span> <span class="hljs-type">Array</span>[<span class="hljs-type">Int</span>](args.numServers)
    <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until args.numServers) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>set the value to -1, which means we don&#39;t know yet, this
will be populated properly on the first message from a reader for this server</p></div></div><div class="code"><div class="wrapper">      seq(i) = -<span class="hljs-number">1</span>
    }
    seq
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">receive</span>:</span> <span class="hljs-type">Actor</span>.<span class="hljs-type">Receive</span> = <span class="hljs-type">LoggingReceive</span> {
    <span class="hljs-keyword">case</span> msg @ <span class="hljs-type">RegisterReader</span>(readerServer, readerPart, totalReader) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>register the reader on one of the worker</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-keyword">val</span> <span class="hljs-title">worker</span> =</span> workers(readerPart % workers.size)
      worker.forward(msg)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>populate the awaitReaders array for that server</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (awaitReaders(readerServer) == -<span class="hljs-number">1</span>) awaitReaders(readerServer) = totalReader
      awaitReaders(readerServer) -= <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>when all the servers are done initializing (we got a register message from all workers), we can
start pulling from them</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (awaitReaders.forall(_ == <span class="hljs-number">0</span>)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>let the workers know</p></div></div><div class="code"><div class="wrapper">        workers.foreach(_ ! <span class="hljs-type">StartReading</span>)
      }

    <span class="hljs-keyword">case</span> <span class="hljs-type">Terminated</span>(_) =&gt;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>one of the worker finished</p></div></div><div class="code"><div class="wrapper">      doneWorkers += <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> (doneWorkers &gt;= workers.size) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>all workers are done pulling logs from the readers. We can now start sorting the part collected for each user</p></div></div><div class="code"><div class="wrapper">        sorter ! <span class="hljs-type">StartSorting</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this actor is now useless, just get rid of it</p></div></div><div class="code"><div class="wrapper">        context.stop(self)
      }
  }
}</div></div></div></div></body></html>